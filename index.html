<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Neural Playground</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0"></script>
</head>
<body>

<h2>Clasificador Neural</h2>
<button id="btnGen" disabled>Generar puntos</button>
<button id="btnMap" disabled>Predecir mapa</button>

<canvas id="canvas" width="500" height="500"></canvas>

<p id="status">Cargando modelo...</p>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const btnGen = document.getElementById("btnGen");
const btnMap = document.getElementById("btnMap");
const statusText = document.getElementById("status");

let model = null;
let points = [];

function colorMap(v){
  return v > 0.5 ? "salmon" : "skyblue";
}

// ===== CARGAR MODELO =====
async function loadModel() {
  try {
    model = await tf.loadLayersModel("web_model/model.json");
    statusText.innerText = "Modelo cargado";
    btnGen.disabled = false;
    btnMap.disabled = false;
    drawGrid();
  } catch(e) {
    statusText.innerText = "Error cargando modelo";
    console.error(e);
  }
}

// ===== GRID =====
function drawGrid() {
  ctx.clearRect(0,0,500,500);
  ctx.strokeStyle = "#ddd";
  for(let i=0;i<=10;i++){
    ctx.beginPath();
    ctx.moveTo(i*50,0);
    ctx.lineTo(i*50,500);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(0,i*50);
    ctx.lineTo(500,i*50);
    ctx.stroke();
  }
}

// ===== GENERAR PUNTOS =====
btnGen.onclick = () => {
  if(!model) return;
  points = [];
  for(let i=0;i<200;i++){
    let x = Math.random()*2 - 1;
    let y = Math.random()*2 - 1;
    points.push([x,y]);
  }
  drawGrid();
  drawPoints();
};

// ===== DIBUJAR PUNTOS =====
function drawPoints(){
  for(let p of points){
    let pred = model.predict(tf.tensor2d([[p[0],p[1]]]));
    pred.data().then(v => {
      ctx.fillStyle = colorMap(v[0]);
      ctx.beginPath();
      ctx.arc((p[0]+1)*250, (p[1]+1)*250, 4, 0, Math.PI*2);
      ctx.fill();
    });
  }
}

// ===== MAPA COMPLETO =====
btnMap.onclick = async () => {
  if(!model) return;
  const res = 100;
  for (let i=0;i<res;i++) {
    for (let j=0;j<res;j++) {
      let x = i/res*2 - 1;
      let y = j/res*2 - 1;
      let pred = model.predict(tf.tensor2d([[x,y]]));
      let v = (await pred.data())[0];
      ctx.fillStyle = colorMap(v);
      ctx.fillRect(i*5, j*5, 5, 5);
    }
  }
  drawPoints();
};

// ===== CLICK INTERACTIVO =====
canvas.addEventListener("click", e => {
  if(!model) return;
  let rect = canvas.getBoundingClientRect();
  let x = (e.clientX - rect.left)/250 - 1;
  let y = (e.clientY - rect.top)/250 - 1;

  let pred = model.predict(tf.tensor2d([[x,y]]));
  pred.data().then(v => {
    ctx.fillStyle = colorMap(v[0]);
    ctx.beginPath();
    ctx.arc((x+1)*250, (y+1)*250, 6, 0, Math.PI*2);
    ctx.fill();
  });
});

// ===== INIT =====
loadModel();
</script>
</body>
</html>
